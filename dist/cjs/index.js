"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=t(e),r=function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)};function o(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function u(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}c((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(u){return function(c){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,u[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,r=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){a=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){a.label=u[1];break}if(6===u[0]&&a.label<o[1]){a.label=o[1],o=u;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(u);break}o[2]&&a.ops.pop(),a.trys.pop();continue}u=t.call(e,a)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,c])}}}"function"==typeof SuppressedError&&SuppressedError;var a={container:{overflow:"hidden",position:"relative",width:"100%",paddingTop:"100%"},hidden:{display:"none"},videoPreview:{top:0,left:0,display:"block",position:"absolute",overflow:"hidden",width:"100%",height:"100%",objectFit:"cover",transform:void 0}},u=Object.prototype.hasOwnProperty;function c(e,t){var n,r;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((r=e.length)===t.length)for(;r--&&c(e[r],t[r]););return-1===r}if(!n||"object"==typeof e){for(n in r=0,e){if(u.call(e,n)&&++r&&!u.call(t,n))return!1;if(!(n in t)||!c(e[n],t[n]))return!1}return Object.keys(t).length===r}}return e!=e&&t!=t}var s,l=function(e){return function(t){return Promise.resolve(e.fn.apply(e,t.data[0])).then((function(t){var n,r="auto"===e.transferable&&(n=t,"ArrayBuffer"in self&&n instanceof ArrayBuffer||"MessagePort"in self&&n instanceof MessagePort||"ImageBitmap"in self&&n instanceof ImageBitmap||"OffscreenCanvas"in self&&n instanceof OffscreenCanvas)?[t]:[];postMessage(["SUCCESS",t],r)})).catch((function(e){postMessage(["ERROR",e])}))}},f=function(e,t,n){var r="\n    "+function(e){return 0===e.length?"":"importScripts("+e.map((function(e){return"'"+e+"'"})).toString()+")"}(t)+";\n    onmessage=("+l+")({\n      fn: ("+e+"),\n      transferable: '"+n+"'\n    })\n  ",o=new Blob([r],{type:"text/javascript"});return URL.createObjectURL(o)};!function(e){e.PENDING="PENDING",e.SUCCESS="SUCCESS",e.RUNNING="RUNNING",e.ERROR="ERROR",e.TIMEOUT_EXPIRED="TIMEOUT_EXPIRED"}(s||(s={}));var d,v=s;!function(e){e.AUTO="auto",e.NONE="none"}(d||(d={}));var p={timeout:void 0,remoteDependencies:[],autoTerminate:!0,transferable:d.AUTO},m=function(e,t){void 0===t&&(t=p);var r,o,i,a=n.default.useState(v.PENDING),u=a[0],s=a[1],l=n.default.useRef(),m=n.default.useRef(!1),h=n.default.useRef({}),w=n.default.useRef(),g=n.default.useCallback((function(e){m.current=e===v.RUNNING,s(e)}),[]),b=n.default.useCallback((function(){var e;null!==(e=l.current)&&void 0!==e&&e._url&&(l.current.terminate(),URL.revokeObjectURL(l.current._url),h.current={},l.current=void 0,window.clearTimeout(w.current))}),[]),y=n.default.useCallback((function(e){(null!=t.autoTerminate?t.autoTerminate:p.autoTerminate)&&b(),g(e)}),[t.autoTerminate,b,g]),R=(r=function(){var n=t.remoteDependencies,r=t.timeout,o=void 0===r?p.timeout:r,i=t.transferable,a=f(e,void 0===n?p.remoteDependencies:n,void 0===i?p.transferable:i),u=new Worker(a);return u._url=a,u.onmessage=function(e){var t,n,r,o,i=e.data,a=i[1];if(i[0]===v.SUCCESS)null===(t=(n=h.current).resolve)||void 0===t||t.call(n,a),y(v.SUCCESS);else null===(r=(o=h.current).reject)||void 0===r||r.call(o,a),y(v.ERROR)},u.onerror=function(e){var t,n;null===(t=(n=h.current).reject)||void 0===t||t.call(n,e),y(v.ERROR)},o&&(w.current=window.setTimeout((function(){b(),g(v.TIMEOUT_EXPIRED)}),o)),u},c((i=n.default.useRef(o=[e,t,b])).current,o)||(i.current=o),n.default.useCallback(r,i.current)),E=n.default.useCallback((function(){var e=[].slice.call(arguments),n=t.transferable,r=void 0===n?p.transferable:n;return new Promise((function(t,n){var o,i;h.current=((o={}).resolve=t,o.reject=n,o);var a=r===d.AUTO?e.filter((function(e){return"ArrayBuffer"in window&&e instanceof ArrayBuffer||"MessagePort"in window&&e instanceof MessagePort||"ImageBitmap"in window&&e instanceof ImageBitmap||"OffscreenCanvas"in window&&e instanceof OffscreenCanvas})):[];null===(i=l.current)||void 0===i||i.postMessage([[].concat(e)],a),g(v.RUNNING)}))}),[g]),S=n.default.useCallback((function(){var e=null!=t.autoTerminate?t.autoTerminate:p.autoTerminate;return m.current?(console.error("[useWorker] You can only run one instance of the worker at a time, if you want to run more than one in parallel, create another instance with the hook useWorker(). Read more: https://github.com/alewin/useWorker"),Promise.reject()):(!e&&l.current||(l.current=R()),E.apply(void 0,[].slice.call(arguments)))}),[t.autoTerminate,R,E]),O={status:u,kill:b};return n.default.useEffect((function(){return function(){b()}}),[b]),[S,O]},h=function(e){return o(void 0,void 0,void 0,(function(){var t,n,r,a;return i(this,(function(u){switch(u.label){case 0:return[4,navigator.mediaDevices.enumerateDevices()];case 1:if((t=(t=u.sent()).filter((function(e){return"videoinput"===e.kind}))).length<1)throw new Error("No video input devices found");return n="environment"===e?/rear|back|environment/gi:/front|user|face/gi,[4,Promise.all(t.filter((function(e){return n.test(e.label)})).map((function(e){return o(void 0,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:e.deviceId}}})];case 1:return(t=n.sent()).getVideoTracks().forEach((function(e){e.getCapabilities(),e.getSettings()})),t.getTracks().forEach((function(e){return e.stop()})),[2,{deviceId:e.deviceId,streamError:!1}];case 2:return n.sent(),[2,{deviceId:e.deviceId,streamError:!0}];case 3:return[2]}}))}))})))];case 2:if(r=u.sent(),!(a=r.filter((function(e){return!e.streamError}))[0]))throw new Error("No video input devices found");return[2,a.deviceId]}}))}))},w=function(e){var t=e.data,n=e.width,r=e.height,o=self.jsQR(t,n,r,{inversionAttempts:"attemptBoth"});try{return JSON.parse(null==o?void 0:o.data)}catch(e){return null==o?void 0:o.data}},g=function(e){var t=e.resolution,n=e.preview,r=e.canvas;return o(void 0,void 0,void 0,(function(){return i(this,(function(e){return[2,new Promise((function(e){if(n&&r||e(null),n.readyState===n.HAVE_ENOUGH_DATA){var o,i,a=Math.floor(n.videoWidth),u=Math.floor(n.videoHeight),c=t/(a<u?a:u);i=((u*=c)-t)/2*-1,o=((a*=c)-t)/2*-1,r.width=t,r.height=t;var s=r.getContext("2d",{alpha:!1});s.imageSmoothingEnabled=!1,s.drawImage(n,o,i,a,u),e(s.getImageData(0,0,r.width,r.height))}else e(null)}))]}))}))},b=function(e){var t=e.facingMode,n=e.constraints,a=e.resolution;return o(void 0,void 0,void 0,(function(){var e,o,u,c,s,l;return i(this,(function(i){switch(i.label){case 0:return e=/firefox/i.test(null===navigator||void 0===navigator?void 0:navigator.userAgent),o=null===(l=null===navigator||void 0===navigator?void 0:navigator.mediaDevices)||void 0===l?void 0:l.getSupportedConstraints(),u={width:{min:a}},(null==o?void 0:o.facingMode)&&(u.facingMode={ideal:t}),(null==o?void 0:o.frameRate)&&(u.frameRate={ideal:25,min:10}),c=null,o.facingMode||e?(c=n||u,[3,3]):[3,1];case 1:return[4,h(t)];case 2:s=i.sent(),c=r({deviceId:s},n),i.label=3;case 3:return[4,navigator.mediaDevices.getUserMedia({video:c})];case 4:return[2,i.sent()]}}))}))},y=function(e){var t=e.preview,n=e.stream;return o(void 0,void 0,void 0,(function(){return i(this,(function(e){return[2,new Promise((function(e,r){try{t&&n||e(),window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,"srcObject"in t?t.srcObject=n:"mozSrcObject"in t?t.mozSrcObject=n:t.src=window.URL&&window.URL.createObjectURL(n)||n,t.setAttribute("playsInline",!0),e()}catch(e){r(e)}}))]}))}))},R=function(t){var n=t.callbacks,r=n[0],a=n[1],u=n[2],c=t.refs,s=c[0],l=c[1],f=t.constraints,d=t.facingMode,v=t.resolution,p=t.debug,h=e.useRef([]),R=e.useRef([]),E=m(w,{remoteDependencies:["https://cdn.jsdelivr.net/npm/jsqr@1.2.0/dist/jsQR.min.js"],autoTerminate:!1}),S=E[0],O=E[1].kill,T=function(){return o(void 0,void 0,void 0,(function(){var e,t,n,r;return i(this,(function(o){switch(o.label){case 0:return o.trys.push([0,3,4,5]),[4,g({preview:l.current,canvas:s.current,resolution:v})];case 1:if(e=o.sent(),p&&p(e,"raw_data"),!e)throw"[QrReader]: error while trying to decode value";return[4,S(e)];case 2:return t=o.sent(),"function"==typeof a&&(p&&p(t,"value"),a(t)),[3,5];case 3:return n=o.sent(),"function"==typeof u&&(p&&p(n,"error"),u(n)),[3,5];case 4:return r=window.requestAnimationFrame(T),h.current.push(r),[7];case 5:return[2]}}))}))},k=function(){return o(void 0,void 0,void 0,(function(){var e,t,n;return i(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),[4,b({constraints:f,resolution:v,facingMode:d})];case 1:return e=o.sent(),R.current.push(e),[4,y({preview:l.current,stream:e})];case 2:return o.sent(),[4,l.current.play()];case 3:return o.sent(),"function"==typeof r&&(p&&p(e,"load"),r(e)),t=window.requestAnimationFrame(T),h.current.push(t),[3,5];case 4:return n=o.sent(),"function"==typeof u&&(p&&p(n,"error"),u(n)),[3,5];case 5:return[2]}}))}))};e.useEffect((function(){var e=setTimeout(k,500);return function(){O(),clearTimeout(e),function(e){e.forEach(window.cancelAnimationFrame)}(h.current),function(e){e&&(e.pause(),e.mozSrcObject=null,e.srcObject=null,e.src="")}(l.current),function(e){var t=new RTCPeerConnection;e.forEach((function(e){e.stop?(e.stop&&e.stop(),t.addStream&&t.addStream(e)):e.getTracks().forEach((function(n){n.enabled=!n.enabled,n.stop(),t.addTrack(n,e)}))}))}(R.current)}}),[])},E=function(t){var o=t.constraints,i=t.facingMode,u=t.resolution,c=t.ViewFinder,s=t.className,l=t.onError,f=t.onScan,d=t.onLoad,v=t.style,p=t.debug,m=e.useRef(null),h=e.useRef(null);return R({callbacks:[d,f,l],refs:[m,h],constraints:o,facingMode:i,resolution:u,debug:p}),n.default.createElement("section",{className:s,style:v},n.default.createElement("section",{style:a.container},!!c&&n.default.createElement(c,null),n.default.createElement("video",{muted:!0,ref:h,style:r(r({},a.videoPreview),{transform:"user"===i&&"scaleX(-1)"})}),n.default.createElement("canvas",{ref:m,style:a.hidden})))};E.displayName="QrReader",E.defaultProps={resolution:600,constraints:null,facingMode:"environment"},exports.QrReader=E;
//# sourceMappingURL=index.js.map

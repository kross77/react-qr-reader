import e,{useRef as n,useEffect as t}from"react";var r=function(){return r=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e},r.apply(this,arguments)};function o(e,n,t,r){return new(t||(t=Promise))((function(o,i){function a(e){try{u(r.next(e))}catch(e){i(e)}}function c(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,c)}u((r=r.apply(e,n||[])).next())}))}function i(e,n){var t,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(u){return function(c){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(t=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=n.call(e,a)}catch(e){c=[6,e],r=0}finally{t=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}}"function"==typeof SuppressedError&&SuppressedError;var a={container:{overflow:"hidden",position:"relative",width:"100%",paddingTop:"100%"},hidden:{display:"none"},videoPreview:{top:0,left:0,display:"block",position:"absolute",overflow:"hidden",width:"100%",height:"100%",objectFit:"cover",transform:void 0}},c=Object.prototype.hasOwnProperty;function u(e,n){var t,r;if(e===n)return!0;if(e&&n&&(t=e.constructor)===n.constructor){if(t===Date)return e.getTime()===n.getTime();if(t===RegExp)return e.toString()===n.toString();if(t===Array){if((r=e.length)===n.length)for(;r--&&u(e[r],n[r]););return-1===r}if(!t||"object"==typeof e){for(t in r=0,e){if(c.call(e,t)&&++r&&!c.call(n,t))return!1;if(!(t in n)||!u(e[t],n[t]))return!1}return Object.keys(n).length===r}}return e!=e&&n!=n}var s,l=function(e){return function(n){return Promise.resolve(e.fn.apply(e,n.data[0])).then((function(n){var t,r="auto"===e.transferable&&(t=n,"ArrayBuffer"in self&&t instanceof ArrayBuffer||"MessagePort"in self&&t instanceof MessagePort||"ImageBitmap"in self&&t instanceof ImageBitmap||"OffscreenCanvas"in self&&t instanceof OffscreenCanvas)?[n]:[];postMessage(["SUCCESS",n],r)})).catch((function(e){postMessage(["ERROR",e])}))}},f=function(e,n,t){var r="\n    "+function(e){return 0===e.length?"":"importScripts("+e.map((function(e){return"'"+e+"'"})).toString()+")"}(n)+";\n    onmessage=("+l+")({\n      fn: ("+e+"),\n      transferable: '"+t+"'\n    })\n  ",o=new Blob([r],{type:"text/javascript"});return URL.createObjectURL(o)};!function(e){e.PENDING="PENDING",e.SUCCESS="SUCCESS",e.RUNNING="RUNNING",e.ERROR="ERROR",e.TIMEOUT_EXPIRED="TIMEOUT_EXPIRED"}(s||(s={}));var d,v=s;!function(e){e.AUTO="auto",e.NONE="none"}(d||(d={}));var m={timeout:void 0,remoteDependencies:[],autoTerminate:!0,transferable:d.AUTO},p=function(n,t){void 0===t&&(t=m);var r,o,i,a=e.useState(v.PENDING),c=a[0],s=a[1],l=e.useRef(),p=e.useRef(!1),h=e.useRef({}),w=e.useRef(),g=e.useCallback((function(e){p.current=e===v.RUNNING,s(e)}),[]),b=e.useCallback((function(){var e;null!==(e=l.current)&&void 0!==e&&e._url&&(l.current.terminate(),URL.revokeObjectURL(l.current._url),h.current={},l.current=void 0,window.clearTimeout(w.current))}),[]),y=e.useCallback((function(e){(null!=t.autoTerminate?t.autoTerminate:m.autoTerminate)&&b(),g(e)}),[t.autoTerminate,b,g]),R=(r=function(){var e=t.remoteDependencies,r=t.timeout,o=void 0===r?m.timeout:r,i=t.transferable,a=f(n,void 0===e?m.remoteDependencies:e,void 0===i?m.transferable:i),c=new Worker(a);return c._url=a,c.onmessage=function(e){var n,t,r,o,i=e.data,a=i[1];if(i[0]===v.SUCCESS)null===(n=(t=h.current).resolve)||void 0===n||n.call(t,a),y(v.SUCCESS);else null===(r=(o=h.current).reject)||void 0===r||r.call(o,a),y(v.ERROR)},c.onerror=function(e){var n,t;null===(n=(t=h.current).reject)||void 0===n||n.call(t,e),y(v.ERROR)},o&&(w.current=window.setTimeout((function(){b(),g(v.TIMEOUT_EXPIRED)}),o)),c},u((i=e.useRef(o=[n,t,b])).current,o)||(i.current=o),e.useCallback(r,i.current)),E=e.useCallback((function(){var e=[].slice.call(arguments),n=t.transferable,r=void 0===n?m.transferable:n;return new Promise((function(n,t){var o,i;h.current=((o={}).resolve=n,o.reject=t,o);var a=r===d.AUTO?e.filter((function(e){return"ArrayBuffer"in window&&e instanceof ArrayBuffer||"MessagePort"in window&&e instanceof MessagePort||"ImageBitmap"in window&&e instanceof ImageBitmap||"OffscreenCanvas"in window&&e instanceof OffscreenCanvas})):[];null===(i=l.current)||void 0===i||i.postMessage([[].concat(e)],a),g(v.RUNNING)}))}),[g]),S=e.useCallback((function(){var e=null!=t.autoTerminate?t.autoTerminate:m.autoTerminate;return p.current?(console.error("[useWorker] You can only run one instance of the worker at a time, if you want to run more than one in parallel, create another instance with the hook useWorker(). Read more: https://github.com/alewin/useWorker"),Promise.reject()):(!e&&l.current||(l.current=R()),E.apply(void 0,[].slice.call(arguments)))}),[t.autoTerminate,R,E]),O={status:c,kill:b};return e.useEffect((function(){return function(){b()}}),[b]),[S,O]},h=function(e){return o(void 0,void 0,void 0,(function(){var n,t,r,a;return i(this,(function(c){switch(c.label){case 0:return[4,navigator.mediaDevices.enumerateDevices()];case 1:if((n=(n=c.sent()).filter((function(e){return"videoinput"===e.kind}))).length<1)throw new Error("No video input devices found");return t="environment"===e?/rear|back|environment/gi:/front|user|face/gi,[4,Promise.all(n.filter((function(e){return t.test(e.label)})).map((function(e){return o(void 0,void 0,void 0,(function(){var n;return i(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:e.deviceId}}})];case 1:return(n=t.sent()).getVideoTracks().forEach((function(e){e.getCapabilities(),e.getSettings()})),n.getTracks().forEach((function(e){return e.stop()})),[2,{deviceId:e.deviceId,streamError:!1}];case 2:return t.sent(),[2,{deviceId:e.deviceId,streamError:!0}];case 3:return[2]}}))}))})))];case 2:if(r=c.sent(),!(a=r.filter((function(e){return!e.streamError}))[0]))throw new Error("No video input devices found");return[2,a.deviceId]}}))}))},w=function(e){var n=e.data,t=e.width,r=e.height,o=self.jsQR(n,t,r,{inversionAttempts:"attemptBoth"});try{return JSON.parse(null==o?void 0:o.data)}catch(e){return null==o?void 0:o.data}},g=function(e){var n=e.resolution,t=e.preview,r=e.canvas;return o(void 0,void 0,void 0,(function(){return i(this,(function(e){return[2,new Promise((function(e){if(t&&r||e(null),t.readyState===t.HAVE_ENOUGH_DATA){var o,i,a=Math.floor(t.videoWidth),c=Math.floor(t.videoHeight),u=n/(a<c?a:c);i=((c*=u)-n)/2*-1,o=((a*=u)-n)/2*-1,r.width=n,r.height=n;var s=r.getContext("2d",{alpha:!1});s.imageSmoothingEnabled=!1,s.drawImage(t,o,i,a,c),e(s.getImageData(0,0,r.width,r.height))}else e(null)}))]}))}))},b=function(e){var n=e.facingMode,t=e.constraints,a=e.resolution;return o(void 0,void 0,void 0,(function(){var e,o,c,u,s,l;return i(this,(function(i){switch(i.label){case 0:return e=/firefox/i.test(null===navigator||void 0===navigator?void 0:navigator.userAgent),o=null===(l=null===navigator||void 0===navigator?void 0:navigator.mediaDevices)||void 0===l?void 0:l.getSupportedConstraints(),c={width:{min:a}},(null==o?void 0:o.facingMode)&&(c.facingMode={ideal:n}),(null==o?void 0:o.frameRate)&&(c.frameRate={ideal:25,min:10}),u=null,o.facingMode||e?(u=t||c,[3,3]):[3,1];case 1:return[4,h(n)];case 2:s=i.sent(),u=r({deviceId:s},t),i.label=3;case 3:return[4,navigator.mediaDevices.getUserMedia({video:u})];case 4:return[2,i.sent()]}}))}))},y=function(e){var n=e.preview,t=e.stream;return o(void 0,void 0,void 0,(function(){return i(this,(function(e){return[2,new Promise((function(e,r){try{n&&t||e(),window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,"srcObject"in n?n.srcObject=t:"mozSrcObject"in n?n.mozSrcObject=t:n.src=window.URL&&window.URL.createObjectURL(t)||t,n.setAttribute("playsInline",!0),e()}catch(e){r(e)}}))]}))}))},R=function(e){var r=e.callbacks,a=r[0],c=r[1],u=r[2],s=e.refs,l=s[0],f=s[1],d=e.constraints,v=e.facingMode,m=e.resolution,h=e.debug,R=n([]),E=n([]),S=p(w,{remoteDependencies:["https://cdn.jsdelivr.net/npm/jsqr@1.2.0/dist/jsQR.min.js"],autoTerminate:!1}),O=S[0],T=S[1].kill,k=function(){return o(void 0,void 0,void 0,(function(){var e,n,t,r;return i(this,(function(o){switch(o.label){case 0:return o.trys.push([0,3,4,5]),[4,g({preview:f.current,canvas:l.current,resolution:m})];case 1:if(e=o.sent(),h&&h(e,"raw_data"),!e)throw"[QrReader]: error while trying to decode value";return[4,O(e)];case 2:return n=o.sent(),"function"==typeof c&&(h&&h(n,"value"),c(n)),[3,5];case 3:return t=o.sent(),"function"==typeof u&&(h&&h(t,"error"),u(t)),[3,5];case 4:return r=window.requestAnimationFrame(k),R.current.push(r),[7];case 5:return[2]}}))}))},U=function(){return o(void 0,void 0,void 0,(function(){var e,n,t;return i(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),[4,b({constraints:d,resolution:m,facingMode:v})];case 1:return e=r.sent(),E.current.push(e),[4,y({preview:f.current,stream:e})];case 2:return r.sent(),[4,f.current.play()];case 3:return r.sent(),"function"==typeof a&&(h&&h(e,"load"),a(e)),n=window.requestAnimationFrame(k),R.current.push(n),[3,5];case 4:return t=r.sent(),"function"==typeof u&&(h&&h(t,"error"),u(t)),[3,5];case 5:return[2]}}))}))};t((function(){var e=setTimeout(U,500);return function(){T(),clearTimeout(e),function(e){e.forEach(window.cancelAnimationFrame)}(R.current),function(e){e&&(e.pause(),e.mozSrcObject=null,e.srcObject=null,e.src="")}(f.current),function(e){var n=new RTCPeerConnection;e.forEach((function(e){e.stop?(e.stop&&e.stop(),n.addStream&&n.addStream(e)):e.getTracks().forEach((function(t){t.enabled=!t.enabled,t.stop(),n.addTrack(t,e)}))}))}(E.current)}}),[])},E=function(t){var o=t.constraints,i=t.facingMode,c=t.resolution,u=t.ViewFinder,s=t.className,l=t.onError,f=t.onScan,d=t.onLoad,v=t.style,m=t.debug,p=n(null),h=n(null);return R({callbacks:[d,f,l],refs:[p,h],constraints:o,facingMode:i,resolution:c,debug:m}),e.createElement("section",{className:s,style:v},e.createElement("section",{style:a.container},!!u&&e.createElement(u,null),e.createElement("video",{muted:!0,ref:h,style:r(r({},a.videoPreview),{transform:"user"===i&&"scaleX(-1)"})}),e.createElement("canvas",{ref:p,style:a.hidden})))};E.displayName="QrReader",E.defaultProps={resolution:600,constraints:null,facingMode:"environment"};export{E as QrReader};
//# sourceMappingURL=index.js.map
